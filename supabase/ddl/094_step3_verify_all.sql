-- ============================================================
-- STEP 4: ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß
-- ============================================================

-- ========================================
-- 4.1: ‡πÄ‡∏ä‡πá‡∏Å UNIQUE constraint ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
-- ========================================
SELECT 
  conname,
  pg_get_constraintdef(oid) AS definition
FROM pg_constraint
WHERE conrelid = 'public.deal_commissions'::regclass
  AND conname = 'deal_commissions_deal_id_role_uniq';

-- ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô: UNIQUE (deal_id, role)

-- ========================================
-- 4.2: ‡πÄ‡∏ä‡πá‡∏Å‡∏ß‡πà‡∏≤‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏°‡∏µ ON CONFLICT
-- ========================================
SELECT 
  CASE 
    WHEN pg_get_functiondef(oid) LIKE '%ON CONFLICT%' 
    THEN '‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏°‡∏µ ON CONFLICT ‡πÅ‡∏•‡πâ‡∏ß'
    ELSE '‚ùå ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ ON CONFLICT'
  END AS status
FROM pg_proc
WHERE proname = 'recalc_deal_commissions'
  AND pronamespace = 'public'::regnamespace;

-- ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô: ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏°‡∏µ ON CONFLICT ‡πÅ‡∏•‡πâ‡∏ß

-- ========================================
-- 4.3: ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• deal_commissions ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
-- ========================================
SELECT 
  deal_id,
  role,
  base_amount,
  commission_amount,
  status,
  created_at
FROM public.deal_commissions
ORDER BY created_at DESC
LIMIT 10;

-- ========================================
-- 4.4: ‡∏´‡∏≤ deal ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ó‡∏î‡∏™‡∏≠‡∏ö
-- ========================================
SELECT 
  id,
  deal_code,
  title,
  stage,
  total_amount
FROM public.deals
WHERE stage != 'won'  -- ‡∏î‡∏µ‡∏•‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î
ORDER BY created_at DESC
LIMIT 5;

-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å deal_code ‡∏à‡∏≤‡∏Å‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡πÄ‡∏ß‡πá‡∏ö

-- ========================================
-- ‡∏™‡∏£‡∏∏‡∏õ: ‡∏ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á 4.1 ‡πÅ‡∏•‡∏∞ 4.2 ‡∏ú‡πà‡∏≤‡∏ô
-- ========================================
-- ‚úÖ UNIQUE constraint ‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß
-- ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß
-- ‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏õ‡∏¥‡∏î‡∏î‡∏µ‡∏•‡πÉ‡∏ô‡πÄ‡∏ß‡πá‡∏ö!

-- ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏ß‡πá‡∏ö ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡∏µ‡∏• ‚Üí ‡∏Å‡∏î "‡∏õ‡∏¥‡∏î‡∏î‡∏µ‡∏• + ‡∏´‡∏±‡∏Å‡∏™‡∏ï‡πá‡∏≠‡∏Å"
-- ‡∏Ñ‡∏ß‡∏£‡πÑ‡∏î‡πâ "‚úÖ ‡∏õ‡∏¥‡∏î‡∏î‡∏µ‡∏•‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß üå±"
